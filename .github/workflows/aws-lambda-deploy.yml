name: Deploy Lambda

on:
    workflow_call:
        inputs:
            branch:
                required: true
                type: string
            function_name:
                required: true
                type: string
        secrets:
            AWS_ACCESS_KEY_ID:
                required: true
            AWS_SECRET_ACCESS_KEY:
                required: true
            AWS_REGION:
                required: true

jobs:
    deploy:
        runs-on: ubuntu-latest
        if: github.ref == format('refs/heads/{0}', inputs.branch)
        steps:
            - uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22.12.0"

            - name: Install Yarn
              run: npm install -g yarn

            - name: Install dependencies
              run: |
                  cd lambda
                  yarn install --frozen-lockfile

            - name: Compile TypeScript sources
              run: |
                  cd lambda
                  yarn tsc

            - name: Package Lambda function
              run: |
                  cd lambda
                  yarn package

            - name: Deploy to AWS Lambda
              run: |
                  aws lambda update-function-code \
                    --function-name ${{ inputs.function_name }} \
                    --zip-file fileb://lambda/lambda-code.zip \
                    --region ${{ secrets.AWS_REGION }}
